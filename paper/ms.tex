\documentclass[manuscript, letterpaper]{aastex6}

% to-do list
% ----------

% style notes
% -----------
% - This file generates by Makefile; don't be typing ``pdflatex'' or some bullshit.
% - Line break between sentences to make the git diffs readable.
% - Use \, as a multiply operator.
% - Reserve () for function arguments; use [] or {} for outer shit.
% - Use \sectionname not Section, \figname not Figure, \documentname not Article or Paper or paper.

\include{gitstuff}
\include{aastexmods}

% packages
\definecolor{cbblue}{HTML}{3182bd}
\usepackage{microtype}  % ALWAYS!
\usepackage{amsmath}
\hypersetup{backref,breaklinks,colorlinks,urlcolor=cbblue,linkcolor=cbblue,citecolor=black}

% define macros for text
\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\acronym}[1]{{\small{#1}}}
\newcommand{\gaia}{\project{Gaia}}
\newcommand{\rave}{\project{\acronym{RAVE}}}
\newcommand{\apogee}{\project{\acronym{APOGEE}}}
\newcommand{\documentname}{\textsl{Article}}
\newcommand{\sectionname}{Section}
\newcommand{\figname}{Figure}
\newcommand{\eqname}{Equation}
\newcommand{\dr}{\acronym{DR1}}

% define macros for math
\newcommand{\given}{\,|\,}
\newcommand{\normal}{{\mathcal{N}}}
\newcommand{\dd}{\mathrm{d}}
\newcommand{\transp}[1]{{#1}^{\!\mathsf{T}}}
\newcommand{\inv}[1]{{#1}^{-1}}
\newcommand{\bs}[1]{\boldsymbol{#1}}
\newcommand{\vperp}{\bs{v}^\perp}
\newcommand{\propm}{\bs{\mu}}
\newcommand{\matrx}[1]{\mathbf{#1}}
\newcommand{\kms}{\rm km~s^{-1}}
\newcommand{\data}{\mathrm{data}}
\newcommand{\snr}{[S/N]_\varpi}

% TODO
\newcommand{\todo}[1]{{\color{red}TODO: #1}}

\begin{document}\sloppy\sloppypar\raggedbottom\frenchspacing % trust me

\title{Co-moving stars in \textsl{Gaia DR1}}
\author{Adrian M. Price-Whelan\altaffilmark{\pu,\adrn},
        Semyeong Oh\altaffilmark{\pu},
        David W. Hogg\altaffilmark{\ccpp,\mpia},
        Timothy D. Morton\altaffilmark{\pu},
        David N. Spergel\altaffilmark{\pu,\cca}
}

% Affiliations
\newcommand{\pu}{1}
\newcommand{\adrn}{2}
\newcommand{\ccpp}{3}
\newcommand{\mpia}{4}
\newcommand{\cca}{5}

\altaffiltext{\pu}{Department of Astrophysical Sciences,
                   Princeton University, Princeton, NJ 08544, USA}
\altaffiltext{\adrn}{To whom correspondence should be addressed:
                     \texttt{adrn@princeton.edu}}
\altaffiltext{\ccpp}{Center for Cosmology and Particle Physics,
                     Department of Physics,
                     New York University, 4 Washington Place,
                     New York, NY 10003, USA}
\altaffiltext{\mpia}{Max-Planck-Institut f\"ur Astronomie,
                     K\"onigstuhl 17, D-69117 Heidelberg, Germany}
\altaffiltext{\cca}{Simons Center for Computational Astrophysics, ...,
                    New York, NY XXXXX, USA}

\begin{abstract}
% Context
The primary sample of the \gaia\ \textsl{First Data Release} is the brand-new
\textsl{Tycho-Gaia Astrometric Solution}. The precision and size of this sample
creates an opportunity to find new binary stars and moving groups, especially
rare binaries or sparsely populated groups.
% Aims
Here we seize this opportunity.
% Methods
We use a justified marginalized likelihood ratio test to separate
pairs of stars with surprisingly similar three-space velocities from
those consistent with being drawn independently from the field
population.  Although we perform some visualizations using a
(bias-corrected) inverse parallax as a distance, the likelihood test
works in the observable space and uses the \gaia\ noise model
responsibly.
% Results
We find pairs of comoving stars out to very wide
separations, including separations of a few parsecs! There does not
seem to be any tidal-disruption feature in the separation distribution
at sub-parsec scales. Pairs at separations beyond a
parsec---whether they are bound in a multiple system or drifting
apart---must be very short-lived. The photometric properties of the
members of these pairs are consistent with youth. The prospects for
testing stellar models and chemical abundance measurements are
superficially discussed.
\end{abstract}

\keywords{
  binaries: visual
  ---
  methods: statistical
  ---
  open clusters and associations: general
  ---
  parallaxes
  ---
  proper motions
  ---
  stars: formation
}

\section{Introduction} \label{sec:intro}

\todo{Some bullshit about binary stars...}

\section{Data} \label{sec:data}

The primary data set used in this \documentname\ is the Tycho-Gaia Astrometric
Solution (TGAS), released as a part of Data Release 1 of the Gaia mission
(\citealt{many}). TGAS contains astrometric measurements (sky position,
parallax, and proper motions) and associated covariance matrices for a large
fraction of the \project{Tycho-2} catalog (\citealt{tycho2}) with median
astrometric precision equivalent to the \project{Hipparcos} catalog ($\approx
0.3~{\rm mas}$; \citealt{hipparcos}). In terms of parallax signal-to-noise
($\snr = \varpi/\sigma_\varpi$), the TGAS catalog contains 1240114 stars
with $\snr > 4$ and 619618 stars with $\snr > 8$. The increase in precision over
Tycho-2 and increase in volume over Hipparcos makes the TGAS catalog a powerful
data set to search for widely-separated, co-moving stars.

In the sections that follow, we construct a statistical model that use the TGAS
data and associated covariances to handle the non-trivial uncertainties [...].
Here, we instead visualize simple quantities constructed directly from the
astrometric measurements to emphasize the quality of the data. For each star
with $\snr > 8$, we use the reported parallax and parallax error to compute a
distance corrected for the Lutz-Kelker bias (\citealt{lutzkelker}):
\begin{equation}
  d = 1000 \, \left[\frac{\varpi}{2} \, \left(1 + \sqrt{1 - \frac{16}{\snr^2}} \right) \right]^{-1} \, {\rm pc}
\end{equation}

\section{Methods} \label{sec:methods}

For a pair of stars $(i,j)$, we want to ratio the fully marginalized likelihood
(FML) of the stars having the same 3-space velocity (hypothesis 1,
$\mathcal{L}_1$) over the FML of the stars having different 3-space velocities
(hypothesis 2, $\mathcal{L}_2$). When this ratio is large, the pair is a
candidate binary star. For \gaia\ DR1, we only observe parallax, $\varpi$, and
two proper motion components, $\propm = (\mu_\alpha, \mu_\delta)$ for each star.
Where there is overlap with \rave\ or \apogee, some number of observed radial
velocities, $v_r$, with observed variances $\sigma^2_{v_r}$ (independent of the
\gaia\ data) may also be available. We assume that the uncertainties in these
observed quantites are known with covariance matrix $\matrx{C}$. The likelihoods
$\mathcal{L}_1, \mathcal{L}_2$ are marginalized over true 3-space velocity and
distance for each star in the pair.
\begin{align}
  \mathcal{L}_1 &=
    \int \, \dd d_i \, \dd d_j \, \dd^3 \bs{v} \,
    L_i(\bs{v}, d_i) \,
    L_j(\bs{v}, d_j) \,
    p(\bs{v}) \, p(d_i) \, p(d_j) \\
  \mathcal{L}_2 &=
    \int \, \dd d_i \, \dd d_j \, \dd^3 \bs{v}_i \, \dd^3 \bs{v}_j \,
    L_i(\bs{v}_i, d_i) \,
    L_j(\bs{v}_j, d_j) \,
    p(\bs{v}_i) \, p(\bs{v}_j) \, p(d_i) \, p(d_j) \\
\end{align}
where
\begin{align}
  L(\bs{v}, d) &=
    \left[\det\left(\frac{\matrx{C}^{-1}}{2\pi}\right)\right]^{1/2} \,
    \exp \left[ -\frac{1}{2} \transp{\left(\bs{x} - \bs{x}_\theta \right)} \,
    \matrx{C}^{-1} \,
    \left(\bs{x} - \bs{x}_\theta \right) \right] \\
  \bs{x} &= \transp{\left(\begin{array}{c c c c} \varpi & \mu_\alpha &
    \mu_\delta & v_r \end{array}\right)} \\
  \bs{x}_\theta &= \transp{\left(\begin{array}{c c c c} \frac{1}{d} & \frac{v_\alpha}{d} &
    \frac{v_\delta}{d} & \tilde{v}_r \end{array}\right)}
\end{align}
\todo{Holy fuck that vector is UGLY}
We assume Gaussian priors on the true velocity components and use a \todo{which
one will we use?} distance prior \citep{Astraatmadja:2016} on heliocentric
distance
\begin{align}
  p(\bs{v}) &= \normal(0,25)~\kms \\
  p(d) &= \frac{r^2}{2\,L^3} \, \exp\left(-r/L\right)
\end{align}

For hypothesis 1, the integral over velocity is non-trivial because the same
``true'' 3-space velocity vector projects into tangential velocity components
differently depending on sky position when the sky separation is appreciable
($v_\alpha = v_\alpha(\bs{v}, \alpha, \delta)$). For hypothesis 2, the integral
can be split into two the product of two simpler integrals $\mathcal{L}_2 = Q_i
\, Q_j$ where
\begin{equation}
  Q = \int \, \dd d \, \dd^3 \bs{v} \, L(\bs{v}, d) \, p(\bs{v}) \, p(d)
\end{equation}

\acknowledgements

This research was partially supported by the \acronym{NSF} (grants
  \acronym{IIS-1124794}, \acronym{AST-1312863}, \acronym{AST-1517237}),
  \acronym{NASA} (grant \acronym{NNX12AI50G}),
  and the Moore-Sloan Data Science Environment at \acronym{NYU}. The data
analysis presented in this article was partially performed on computational
resources supported by the Princeton Institute for Computational Science and
Engineering (PICSciE) and the Office of Information Technology's High
Performance Computing Center and Visualization Laboratory at Princeton
University.

\software{The code used in this project is available from
\url{https://github.com/smoh/gaia-wide-binaries} under the MIT open-source
software license. This version was generated at git commit
\texttt{\githash\,(\gitdate)}.
This research additionally utilized:
    \texttt{Astropy} (\citealt{Astropy-Collaboration:2013}),
    %\texttt{emcee} (\citealt{Foreman-Mackey:2013}),
    \texttt{IPython} (\citealt{Perez:2007}),
    \texttt{matplotlib} (\citealt{Hunter:2007}),
    and \texttt{numpy} (\citealt{Van-der-Walt:2011}).}

% \facility{\sdssiii, \apogee}

\bibliographystyle{aasjournal}
\bibliography{refs}

\appendix
\section{Some mathematics relevant to the above}

In what follows, all vectors are column vectors, unless we have transposed them.
We indicate whether a symbol represents a scalar, vector, or tensor
(matrix) by context, not typesetting.
Properties of the squared exponential:
\begin{eqnarray}
  \ln\left[\int\exp(-\frac{1}{2}\,\transp{[x-\nu]}\,\inv{A}\,[x-\nu] - \Delta)\,\dd x\right]
  &=& +\frac{1}{2}\ln ||2\pi\,A|| -\Delta
  \quad ,
\end{eqnarray}
where $x$ and $\nu$ are $D$-dimensional vectors, $A$ is a positive definite
matrix, $\Delta$ is a scalar, and the integral is implicitly over all
of $D$-dimensional $x$-space.
We will need to complete squares.
If we equate
\begin{eqnarray}
  \frac{1}{2}\,\transp{[x-\nu]}\,\inv{A}\,[x-\nu] + \Delta
  &=& \frac{1}{2}\,\transp{x}\,\inv{A}\,x + \transp{x}\,B\,b + C
  \quad ,
\end{eqnarray}
where $B\,b$ is a $d$-vector, and $C$ is a scalar, then we find
\begin{eqnarray}
  \nu &=& -A\,B\,b
  \\
  \Delta & = & C - \frac{1}{2}\,\transp{\nu}\,\inv{A}\,\nu
  \quad .
\end{eqnarray}

Now in this case, we want to write down the probability density for the data
given the distances and velocity (the likelihood), and the prior pdf for
the velocity, and their product.
The prior pdf for the velocity is Gaussian:
\begin{eqnarray}
  p(v) &=& \normal(v\given 0,V)
  \\
  \ln p(v) &=& -\frac{1}{2}\,\ln||2\pi\,V|| -\frac{1}{2}\,\transp{v}\,\inv{V}\,v
  \\
  V &=& \sigma_v^2\,I
  \quad ,
\end{eqnarray}
where $v$ is the three-vector velocity, and $V$ is an isotropic
variance tensor.
Similarly, the likelihood for the data is also a Gaussian.
Before we write that down, we will make some definitions.
We construct a velocity-space data vector $y$ as follows:
\begin{eqnarray}
  \transp{y} &\equiv& [(d_1\,\mu_{\alpha1}), (d_1\,\mu_{\delta1}),
                       (d_2\,\mu_{\alpha2}), (d_2\,\mu_{\delta2})] \quad \mbox{or}
  \\
  \transp{y} &\equiv& [(d_1\,\mu_{\alpha1}), (d_1\,\mu_{\delta1}), (v_{r1}),
                       (d_2\,\mu_{\alpha2}), (d_2\,\mu_{\delta2}), (v_{r2})]
  \quad ,
\end{eqnarray}
where we have given two versions, a 4-component and an 6-component
version (depending on whether there are measured radial velocities),
the subscripts 1, 2 refer to the first and second stars (arbitrarily
ordered) of the pair, we have multiplied the strict observables by
distances $d_1, d_2$, which we are permitted to do (because we are
\emph{conditioning} on $d_1, d_2$), and note the wacky minus-ones.
The vector $y$ is a column vector that we have transposed to make it
easy to write down.
Fundamentally, our H1 model (same velocity) is
\begin{eqnarray}
  y &=& M\,v + \mathrm{noise}
  \\
  \transp{M} &=& [\hat{\alpha_1}, \hat{\delta_1},
                  \hat{\alpha_2}, \hat{\delta_2}] \quad \mbox{or}
  \\
  \transp{M} &=& [\hat{\alpha}_1, \hat{\delta}_2, \hat{r}_1,
                  \hat{\alpha}_2, \hat{\delta}_2, \hat{r}_2]
  \quad,
\end{eqnarray}
where $M$ is a $6\times 3$ or $8\times 3$ design matrix, with zeros
in two rows, and unit vectors along the other rows.
The noise (in the $y$ vector) is drawn from a Gaussian with ($6\times 6$ or $8\times 8$)
covariance matrix $\Sigma$, constructed from the distances $d_1, d_2$ and
the \gaia-provided individual-object covariance matrices.
Given all these definitions, the likelihood function is
\begin{eqnarray}
  p(\data\given v,d_1,d_2) &=& d_1^2\,d_2^2\,\normal(y\given M\,v, \Sigma)
  \\
  \ln p(\data\given v,d_1,d_2) &=& 3\,\ln d_1 + 3\,\ln d_2
  -\frac{1}{2}\,\ln||2\pi\,\Sigma|| \nonumber \\ && \quad
  -\frac{1}{2}\,\transp{[y-M\,v]}\,\inv{\Sigma}\,[y-M\,v]
  \quad ,
\end{eqnarray}
where the factor of $d_1^2\,d_2^2$ converts to units of per \gaia\ data
from units of per $y$.

Now we multiply together (add in the log) and complete the square.
We get, in the original parameterization:
\begin{eqnarray}
  \inv{A} &=& [\transp{M}\,\inv{\Sigma}\,M+\inv{V}]
  \\
  \nu &=& -A\,\transp{M}\,\inv{\Sigma}\,y
  \\
  \Delta &=& -2\,\ln d_1 -2\,\ln d_2
  +\frac{1}{2}\,\ln||2\pi\,\Sigma|| +\frac{1}{2}\,\ln||2\pi\,V|| \nonumber \\ && \quad
  +\frac{1}{2}\,\transp{y}\,\inv{\Sigma}\,y -\frac{1}{2}\,\transp{\nu}\,\inv{A}\,\nu
  \quad ,
\end{eqnarray}
where there are sign issues that Hogg doesn't like to think about.
Finally, we marginalize out the velocity to get the marginalized
likelihood conditioned on the two distances $d_1, d_2$:
\begin{eqnarray}
  \ln p(\data\given d_1,d_2)
  &=& \frac{1}{2}\ln ||2\pi\,A|| -\Delta
  \quad .
\end{eqnarray}

The story for the H2 model (independent velocities) is very
similar. In this case, the marginalized likelihood is a product of
two independent integrals $Q$ each constructed as follows:
\begin{eqnarray}
  \transp{y} &\equiv& [(d\,\mu_{\alpha}), (d\,\mu_{\delta})] \quad \mbox{or}
  \\
  \transp{y} &\equiv& [(d\,\mu_{\alpha}), (d\,\mu_{\delta}), (v_{r})]
  \\
  \transp{M} &=& [\hat{\alpha}, \hat{\delta}] \quad \mbox{or}
  \\
  \transp{M} &=& [\hat{\alpha}, \hat{\delta}_2, \hat{r}]
  \\
  \inv{A} &=& [\transp{M}\,\inv{\Sigma}\,M+\inv{V}]
  \\
  \nu &=& A\,\transp{M}\,\inv{\Sigma}\,y
  \\
  \Delta &=& -2\,\ln d
  +\frac{1}{2}\,\ln||2\pi\,\Sigma|| +\frac{1}{2}\,\ln||2\pi\,V|| \nonumber \\ && \quad
  +\frac{1}{2}\,\transp{y}\,\inv{\Sigma}\,y -\frac{1}{2}\,\transp{\nu}\,\inv{A}\,\nu
  \\
  Q &=& \frac{1}{2}\ln ||2\pi\,A|| -\Delta
  \quad ,
\end{eqnarray}
where again there are two options for the dimensionality of $y$ and
$M$, and once the vectors and $\Sigma$ are properly truncated to one
star, everything else follows.

\end{document}
