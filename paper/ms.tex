\documentclass[manuscript, letterpaper]{aastex6}

% to-do list
% ----------

% style notes
% -----------
% - This file generates by Makefile; don't be typing ``pdflatex'' or some bullshit.
% - Line break between sentences to make the git diffs readable.
% - Use \, as a multiply operator.
% - Reserve () for function arguments; use [] or {} for outer shit.
% - Use \sectionname not Section, \figname not Figure, \documentname not Article or Paper or paper.

\include{gitstuff}
\include{aastexmods}

% packages
\definecolor{cbblue}{HTML}{3182bd}
\usepackage{microtype}  % ALWAYS!
\usepackage{amsmath}
\hypersetup{backref,breaklinks,colorlinks,urlcolor=cbblue,linkcolor=cbblue,citecolor=black}

% define macros for text
\newcommand{\project}[1]{\textsl{#1}}
\newcommand{\acronym}[1]{{\small{#1}}}
\newcommand{\gaia}{\project{Gaia}}
\newcommand{\rave}{\project{\acronym{RAVE}}}
\newcommand{\apogee}{\project{\acronym{APOGEE}}}
\newcommand{\documentname}{\textsl{Article}}
\newcommand{\sectionname}{Section}
\newcommand{\figname}{Figure}
\newcommand{\eqname}{Equation}

% define macros for math
\newcommand{\given}{\,|\,}
\newcommand{\normal}{N}
\newcommand{\dd}{\mathrm{d}}
\newcommand{\transp}[1]{{#1}^{\!\mathsf{T}}}
\newcommand{\inv}[1]{{#1}^{-1}}
\newcommand{\bs}[1]{\boldsymbol{#1}}
\newcommand{\vperp}{\bs{v}^\perp}
\newcommand{\propm}{\bs{\mu}}
\newcommand{\matrx}[1]{\mathbf{#1}}
\newcommand{\kms}{\rm km~s^{-1}}
\newcommand{\data}{\mathrm{data}}

% TODO
\newcommand{\todo}[1]{{\color{red}TODO: #1}}

\begin{document}\sloppy\sloppypar\raggedbottom\frenchspacing % trust me

\title{Wide binaries in Gaia DR1}
\author{People}

% Affiliations
% \newcommand{\pu}{1}
% \newcommand{\adrn}{2}
% \newcommand{\ccpp}{3}
% \newcommand{\mpia}{4}
% \newcommand{\uw}{5}
% \newcommand{\sagan}{6}

% \altaffiltext{\pu}{Department of Astrophysical Sciences,
%                    Princeton University, Princeton, NJ 08544, USA}
% \altaffiltext{\adrn}{To whom correspondence should be addressed:
%                      \texttt{adrn@princeton.edu}}
% \altaffiltext{\ccpp}{Center for Cosmology and Particle Physics,
%                      Department of Physics,
%                      New York University, 4 Washington Place,
%                      New York, NY 10003, USA}
% \altaffiltext{\mpia}{Max-Planck-Institut f\"ur Astronomie,
%                      K\"onigstuhl 17, D-69117 Heidelberg, Germany}
% \altaffiltext{\uw}{Astronomy Department, University of Washington,
%                    Seattle, WA 98195, USA}
% \altaffiltext{\sagan}{Sagan Fellow}

\begin{abstract}
Blerg.
% Context
% Aims
% Methods
% Results
\end{abstract}

\keywords{
  methods: data analysis
  ---
  methods: statistical
}

\section{Introduction} \label{sec:intro}

\section{Methods} \label{sec:methods}

For a pair of stars $(i,j)$, we want to ratio the fully marginalized likelihood
(FML) of the stars having the same 3-space velocity (hypothesis 1,
$\mathcal{L}_1$) over the FML of the stars having different 3-space velocities
(hypothesis 2, $\mathcal{L}_2$). When this ratio is large, the pair is a
candidate binary star. For \gaia\ DR1, we only observe parallax, $\varpi$, and
two proper motion components, $\propm = (\mu_\alpha, \mu_\delta)$ for each star.
Where there is overlap with \rave\ or \apogee, some number of observed radial
velocities, $v_r$, with observed variances $\sigma^2_{v_r}$ (independent of the
\gaia\ data) may also be available. We assume that the uncertainties in these
observed quantites are known with covariance matrix $\matrx{C}$. The likelihoods
$\mathcal{L}_1, \mathcal{L}_2$ are marginalized over true 3-space velocity and
distance for each star in the pair.
\begin{align}
  \mathcal{L}_1 &=
    \int \, \dd d_i \, \dd d_j \, \dd^3 \bs{v} \,
    L_i(\bs{v}, d_i) \,
    L_j(\bs{v}, d_j) \,
    p(\bs{v}) \, p(d_i) \, p(d_j) \\
  \mathcal{L}_2 &=
    \int \, \dd d_i \, \dd d_j \, \dd^3 \bs{v}_i \, \dd^3 \bs{v}_j \,
    L_i(\bs{v}_i, d_i) \,
    L_j(\bs{v}_j, d_j) \,
    p(\bs{v}_i) \, p(\bs{v}_j) \, p(d_i) \, p(d_j) \\
\end{align}
where
\begin{align}
  L(\bs{v}, d) &=
    \left[\det\left(\frac{\matrx{C}^{-1}}{2\pi}\right)\right]^{1/2} \,
    \exp \left[ -\frac{1}{2} \transp{\left(\bs{x} - \bs{x}_\theta \right)} \,
    \matrx{C}^{-1} \,
    \left(\bs{x} - \bs{x}_\theta \right) \right] \\
  \bs{x} &= \transp{\left(\begin{array}{c c c c} \varpi & \mu_\alpha &
    \mu_\delta & v_r \end{array}\right)} \\
  \bs{x}_\theta &= \transp{\left(\begin{array}{c c c c} \frac{1}{d} & \frac{v_\alpha}{d} &
    \frac{v_\delta}{d} & \tilde{v}_r \end{array}\right)}
\end{align}
\todo{Holy fuck that vector is UGLY}
We assume Gaussian priors on the true velocity components and use a \todo{which
one will we use?} distance prior \citep{Astraatmadja:2016} on heliocentric
distance
\begin{align}
  p(\bs{v}) &= \mathcal{N}(0,25)~\kms \\
  p(d) &= \frac{r^2}{2\,L^3} \, \exp\left(-r/L\right)
\end{align}

For hypothesis 1, the integral over velocity is non-trivial because the same
``true'' 3-space velocity vector projects into tangential velocity components
differently depending on sky position when the sky separation is appreciable
($v_\alpha = v_\alpha(\bs{v}, \alpha, \delta)$). For hypothesis 2, the integral
can be split into two the product of two simpler integrals $\mathcal{L}_2 = Q_i
\, Q_j$ where
\begin{equation}
  Q = \int \, \dd d \, \dd^3 \bs{v} \, L(\bs{v}, d) \, p(\bs{v}) \, p(d)
\end{equation}

\appendix

Here we derive analytic expressions for the marginal likelihood integrals above.

\todo{Hypothesis 1}

The integrals for Hypothesis 2 are somewhat easier because the true velocity
vector can be considered to be already in the orthogonal basis defined by the
tangent plane at the coordinates of the source (we are assuming an isotropic
velocity prior). We will analytically integrate over the velocity components
$(v_\alpha,v_\delta,v_r)$ and leave the distance integral to be done
numerically:
\begin{equation}
  \int \, \dd^3\bs{v} \, L(\bs{v}, d) \, p(\bs{v})
\end{equation}
The covariance matrix over parallax, proper motion components, and
radial velocity (if they exist) is $\matrx{C}$ and the inverse variance matrix
is $\matrx{V}$. Defining the constant
\begin{equation}
  \mathcal{Z} = \left[ \det \left(\frac{\matrx{V}}{2\pi} \right) \right]^{1/2}
\end{equation}
the integrand can be written
\begin{equation}
  L(\bs{v}, d) \, p(\bs{v}) = \mathcal{Z} \,
    \exp \left[ -\frac{1}{2} \transp{\left(\bs{x} - \bs{x}_\theta \right)} \,
    \matrx{V} \,
    \left(\bs{x} - \bs{x}_\theta \right)
    - \frac{|\bs{v}|^2}{2\,\sigma^2} \right] \\
\end{equation}
The integral over radial velocity is simple and can be performed without
considering any other terms because uncertainties in these measurements will
not, in general, be covariant with the Gaia data. The integrand over tangential
velocities can then be written
\begin{equation}
  L(v_\alpha, v_\delta, d) \, p(v_\alpha, v_\delta) = \tilde{\mathcal{Z}} \,
    \exp \left[ -\frac{1}{2}\,\transp{\left(\bs{x}' - \bs{x}'_\theta \right)} \,
    \matrx{V}' \,
    \left(\bs{x}' - \bs{x}'_\theta \right)
    - \frac{(v_\alpha^2 + v_\delta^2)}{2\,\sigma^2} \right]
    \label{eq:vtan-integrand}
\end{equation}
where the primed variables indicate that they are in the sub-space of just the
astrometric quantities, the constant pre-factor now includes the integral over
radial velocity
\begin{align}
  \tilde{\mathcal{Z}} = \mathcal{Z} \,
    \exp\left[-\frac{1}{2}\frac{v_r^2}{\sigma_{v_r}^2 + \sigma^2}\right] \,
    \left[ 2\pi \, (\sigma_{v_r}^2 + \sigma^2) \right]^{1/2}
\end{align}
and $\sigma_{v_r}$ is the observational uncertainty of the radial velocity
measurement. To perform the integral over tangential velocities, we partition
the inverse variance matrix and vectors so that
\begin{align}
  \bs{x}_A &= (\varpi)\\
  \bs{x}_B &= (\mu_\alpha, \mu_\delta)\\
  \bs{x}_{\theta, A} &= (d^{-1}) \\
  \bs{x}_{\theta, B} &= (d^{-1}\,v_\alpha, d^{-1}\,v_\delta) \\
  \matrx{V} &=
    \left(\begin{array}{c| c c}
      V_{11} & V_{12} & V_{13}\\\hline
      V_{12} & V_{22} & V_{23}\\
      V_{13} & V_{23} & V_{33}
    \end{array}\right)
    = \left(\begin{array}{c c}
      \matrx{V}_{AA} & \matrx{V}_{AB}\\
      \matrx{V}_{AB} & \matrx{V}_{BB}
    \end{array}\right)
\end{align}
\todo{Holy fuck that matrix is UGLY - fix with new version of AASTex 6}
and the argument of the Gaussian in \eqname~\ref{eq:vtan-integrand} can be
written
\begin{multline}
  -\frac{1}{2}\,[
  \transp{(\bs{x}_A - \bs{x}_{\theta, A})}\,
    \matrx{V}_{AA}\,(\bs{x}_A - \bs{x}_{\theta, A})\\
  + \transp{(\bs{x}_B - \bs{x}_{\theta, B})}\,
    \matrx{V}_{BB}\,(\bs{x}_B - \bs{x}_{\theta, B})\\
  + 2\,\transp{(\bs{x}_A - \bs{x}_{\theta, A})}\,
    \matrx{V}_{AB}\,(\bs{x}_B - \bs{x}_{\theta, B})]
\end{multline}
\todo{prior in above}

\acknowledgements

This research was partially supported by the \acronym{NSF} (grants
  \acronym{IIS-1124794}, \acronym{AST-1312863}, \acronym{AST-1517237}),
  \acronym{NASA} (grant \acronym{NNX12AI50G}),
  and the Moore-Sloan Data Science Environment at \acronym{NYU}. The data
analysis presented in this article was partially performed on computational
resources supported by the Princeton Institute for Computational Science and
Engineering (PICSciE) and the Office of Information Technology's High
Performance Computing Center and Visualization Laboratory at Princeton
University.

\software{The code used in this project is available from
\url{https://github.com/smoh/gaia-wide-binaries} under the MIT open-source
software license. This version was generated at git commit
\texttt{\githash\,(\gitdate)}.
This research additionally utilized:
    \texttt{Astropy} (\citealt{Astropy-Collaboration:2013}),
    %\texttt{emcee} (\citealt{Foreman-Mackey:2013}),
    \texttt{IPython} (\citealt{Perez:2007}),
    \texttt{matplotlib} (\citealt{Hunter:2007}),
    and \texttt{numpy} (\citealt{Van-der-Walt:2011}).}

% \facility{\sdssiii, \apogee}

\bibliographystyle{aasjournal}
\bibliography{refs}

\appendix
\section{Some mathematics relevant to the above}

In what follows, all vectors are column vectors.
We indicate whether a symbol represents a scalar, vector, or tensor
(matrix) by context, not typesetting.
Properties of the squared exponential:
\begin{eqnarray}
  \ln\left[\int\exp(-\frac{1}{2}\,\transp{[x-\nu]}\,\inv{A}\,[x-\nu] - \Delta)\,\dd x\right]
  &=& \frac{D}{2}\,\ln 2\pi +\frac{1}{2}\ln ||A|| -\Delta
  \quad ,
\end{eqnarray}
where $x$ and $\nu$ are $D$-dimensional vectors, $A$ is a symmetric
matrix, $\Delta$ is a scalar, and the integral is implicitly over all
of $D$-dimensional $x$-space.
We will need to complete squares.
If we equate
\begin{eqnarray}
  \frac{1}{2}\,\transp{[x-\nu]}\,\inv{A}\,[x-\nu] + \Delta
  &=& \frac{1}{2}\,\transp{x}\,\inv{A}\,x + \transp{x}\,B\,b + C
  \quad ,
\end{eqnarray}
where $B\,b$ is a $d$-vector, and $C$ is a scalar, then we find
\begin{eqnarray}
  \nu &=& A\,B\,b
  \\
  C & = & \Delta - \frac{1}{2}\,\transp{\nu}\,\inv{A}\,\nu
  \quad .
\end{eqnarray}

Now in this case, we want to write down the probability of the data
given the distance and velocity (the likelihood), and the prior pdf for
the velocity, and their product.
The prior pdf for the velocity is Gaussian:
\begin{eqnarray}
  p(v) &=& \normal(v\given 0,V)
  \\
  \ln p(v) &=& -\frac{3}{2}\,\ln 2\pi -\frac{1}{2}\,\ln||V|| -\frac{1}{2}\,\transp{v}\,\inv{V}\,v
  \\
  V &=& \sigma_v^2\,I
  \quad ,
\end{eqnarray}
where $v$ is the three-vector velocity, and $V$ is an isotropic
variance tensor.
Similarly, the likelihood for the data is also a Gaussian.
Before we write that down, we will make some definitions.
We construct a vector $y$ as follows:
\begin{eqnarray}
  \transp{y} &\equiv& [(d_1\,\varpi_1 - 1), d_1\,\mu_{\alpha,1}, d_1\,\mu_{\delta,1},
                       d_1\,\varpi_2 - 1, d_2\,\mu_{\alpha,2}, d_1\,\mu_{\delta,2}]
  \\
  \transp{y} &\equiv& [(d_1\,\varpi_1 - 1), d_1\,\mu_{\alpha,1}, d_1\,\mu_{\delta,1}, v_{r,1}
                       d_1\,\varpi_2 - 1, d_2\,\mu_{\alpha,2}, d_1\,\mu_{\delta,2}, v_{r,2}
  \quad ,
\end{eqnarray}
where we have given two versions, a 6-component and an 8-component
version (depending on whether there are measured radial velocities),
the subscripts 1, 2 refer to the first and second stars (arbitrarily
ordered) of the pair, we have multiplied the strict observables by
distances $d_1, d_2$, which we are permitted to do (because we are
\emph{conditioning} on $d_1, d_2$), and note the wacky minus-ones.
The vector $y$ is a column vector that we have transposed to make it
easy to write down.
Fundamentally, our model is
\begin{eqnarray}
  y &=& M\,v + \mathrm{noise}
  \\
  \transp{M} &=& [0, \hat{\alpha_1}, \hat{\delta_1},
                  0, \hat{\alpha_2}, \hat{\delta_2}]
  \\
  \transp{M} &=& [0, \hat{\alpha}_1, \hat{\delta}_2, \hat{r}_1,
                  0, \hat{\alpha}_2, \hat{\delta}_2, \hat{r}_2]
  \quad,
\end{eqnarray}
where $M$ is a $6\times 3$ or $8\times 3$ design matrix, with zeros
in two rows, and unit vectors along the other rows.
The noise (in the $y$ vector) is drawn from a Gaussian with ($6\times 6$ or $8\times 8$)
covariance matrix $\Sigma$, constructed from the distances $d_1, d_2$ and
the \gaia-provided individual-object covariance matrices.
Given all these definitions, the likelihood function is
\begin{eqnarray}
  p(\data\given v,d_1,d_2) &=& d_1^3\,d_2^3\,\normal(y\given M\,v, \Sigma)
  \\
  \ln p(\data\given v,d_1,d_2) &=& 3\,\ln d_1 + 3\,\ln d_2 -\frac{6~\mathrm{or}~8}{2}\,\ln 2\pi
  -\frac{1}{2}\,\ln||\Sigma|| \\ && \quad -\frac{1}{2}\,\transp{[y-M\,v]}\,\inv{\Sigma}\,[y-M\,v]
  \quad ,
\end{eqnarray}
where the factor of $d_1^2\,d_2^3$ converts to units of \gaia\ data
from units of $y$.

Now we multiply together (add in the log) and complete the square.
We get, in the original parameterization:
\begin{eqnarray}
  \nu &=& \inv{[\transp{M}\,\inv{\Sigma}\,M+\inv{V}]}\,\transp{M}\,\inv{\Sigma}\,y
  \\
  \Delta &=& 3\,\ln d_1 + 3\,\ln d_2 -\frac{9~\mathrm{or}~11}{2}\,\ln 2\pi
  -\frac{1}{2}\,\ln||\Sigma|| -\frac{1}{2}\,\ln||V|| \\
  &&\quad -\frac{1}{2}\,\transp{y}\,\inv{\Sigma}\,y -\frac{1}{2}\,\transp{\nu}\,\inv{[\transp{M}\,\inv{\Sigma}\,M+\inv{V}]}\,\nu
  \\
  \ln p(\data\given d_1,d_2) &=& [HOGG]
  \quad ,
\end{eqnarray}
where....HOGG

\end{document}
